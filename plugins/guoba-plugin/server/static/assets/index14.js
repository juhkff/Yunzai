var __async=(__this,__arguments,generator)=>new Promise(((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())}));import{d as defineComponent,r as ref,C as computed,a as reactive,j as createVNode,w as watch,k as createTextVNode,g0 as pluginApi,c as resolveComponent,o as openBlock,h as createBlock,i as withCtx,y as unref,x as createCommentVNode,v as createBaseVNode,as as withModifiers,m as toDisplayString,A as useMessage,u as usePrompt}from"./index.js";import{B as BasicTable}from"./TableImg.vue_vue_type_style_index_0_lang.js";import{T as TableAction}from"./BasicForm.vue_vue_type_style_index_0_lang.js";import{u as useTable}from"./useTable.js";import{_ as _sfc_main$1}from"./TableBatchDropdown.vue_vue_type_script_setup_true_lang.js";import{P as PageWrapper}from"./index30.js";import{a as useModal}from"./index19.js";import{columns}from"./plugins.data.js";import{u as useGuobaStore}from"./index34.js";import{G as GPluginModal}from"./GPluginModal.js";/* empty css       *//* empty css                                                          */import{a as sleep}from"./common.js";import"./BasicForm.js";import"./upperFirst.js";import"./uniqBy.js";import"./index21.js";import"./index22.js";import"./useFormItem.js";import"./DeleteOutlined.js";import"./transButton.js";import"./download.js";import"./index23.js";import"./index24.js";import"./useWindowSizeFn.js";import"./FullscreenOutlined.js";import"./merge.js";import"./onMountedOrActivated.js";import"./sortable.esm.js";import"./RedoOutlined.js";import"./scrollTo.js";import"./index33.js";import"./index32.js";import"./useContentViewHeight.js";import"./ArrowLeftOutlined.js";import"./guoba.js";import"./index31.js";import"./MarkdownViewer.vue_vue_type_script_setup_true_lang.js";import"./lodash.default.js";import"./throttle.js";const _hoisted_1=createBaseVNode("a",{href:"https://gitee.com/yhArcadia/Yunzai-Bot-plugins-index",target:"_blank"}," Yunzai-Bot插件索引 ",-1),_hoisted_2=createBaseVNode("span",null,"安装自定义插件",-1),_hoisted_3=["onClick"],_sfc_main=defineComponent({__name:"index",setup(__props){const guobaStore=useGuobaStore(),loading=ref(!1),pluginStatusRef=ref(1),allPlugins=ref([]),authorOptions=computed((()=>allPlugins.value.reduce(((prev,curr)=>{let author=curr.author;return Array.isArray(author)||(author=[author]),author.forEach((item=>{prev.includes(item)||prev.push(item)})),prev}),[]).map((item=>({label:item.replace(/^@/,""),value:item}))))),[registerModal,{openModal:openModal}]=useModal(),searchInfo=reactive({}),rowSelection=reactive({type:"checkbox",selectedRowKeys:[],onChange:$selectedRowKeys=>{rowSelection.selectedRowKeys=$selectedRowKeys}}),[registerTable,{reload:reload,updateTableDataRecord:updateTableDataRecord}]=useTable({title:()=>{let text="",showBatch=!1;return 0===pluginStatusRef.value?text="未安装的插件":0===rowSelection.selectedRowKeys.length?text="已安装的插件":(showBatch=!0,text=`已选中 ${rowSelection.selectedRowKeys.length} 个插件`),createVNode(_sfc_main$1,{showBatch:showBatch,text:text,onClear:()=>rowSelection.selectedRowKeys=[],onMenuClick:e=>{if("uninstall-batch"===e.key)!function(){createConfirm({title:"批量卸载",iconType:"warning",content:createVNode("div",null,[createVNode("p",null,[createTextVNode("确定要批量卸载以下插件吗？")]),createVNode("p",null,[createVNode("ul",null,[rowSelection.selectedRowKeys.map(((name,idx)=>createVNode("li",{key:name},[idx+1,createTextVNode(". "),name])))])]),createVNode("p",null,[createTextVNode("将会删除插件目录包括可能产生的数据以及配置，且无法恢复！")]),createVNode("p",null,[createTextVNode("请谨慎操作，卸载后会立即重启！")])]),onOk:()=>__async(this,null,(function*(){try{loading.value=!0;const names=rowSelection.selectedRowKeys.join(",");let data=yield pluginApi.uninstallPlugin(names);if("success"===data.status){let msgLines=data.message.split("\n");createInfoModal({title:"批量卸载完成",content:createVNode("div",null,[msgLines.map((line=>createVNode("span",null,[line,createVNode("br",null,null)])))]),onOk(){return __async(this,null,(function*(){yield sleep(3e3),window.location.reload()}))}})}else $message.error(data.message)}finally{loading.value=!1}}))})}()}},null)},api:function(params){return __async(this,null,(function*(){const plugins=yield guobaStore.getPlugins();if(!plugins||0===plugins.length)return[];allPlugins.value=plugins;let{keywords:keywords="",authors:authors=[]}=params;return Array.isArray(authors)||(authors=[]),plugins.filter((plugin=>{if(!(1===pluginStatusRef.value?plugin.installed:!plugin.installed))return!1;if(keywords){const reg=new RegExp(keywords,"i");if(!reg.test(plugin.title)&&!reg.test(plugin.name)&&!reg.test(plugin.description))return!1}if(authors.length>0){let author=plugin.author;if(Array.isArray(author)||(author=[author]),!author.some((item=>authors.includes(item))))return!1}return!0}))}))},rowKey:"name",columns:columns,useSearchForm:!0,formConfig:{baseColProps:{xs:24,sm:8,md:6,lg:8,xl:8,xxl:8},actionColOptions:{xs:24,sm:8,md:8,lg:8,xl:8,xxl:8,style:{paddingLeft:"8px",textAlign:"left"}},labelCol:{xs:24,sm:6},wrapperCol:{xs:24,sm:18},schemas:[{label:"过滤正则",field:"keywords",component:"Input",componentProps:{placeholder:"可匹配插件标题、插件名称、插件说明",onPressEnter:()=>reload()}},{label:"插件作者",field:"authors",component:"Select",componentProps:()=>({placeholder:"请选择插件作者",mode:"multiple",options:authorOptions.value})}]},showTableSetting:!0,bordered:!0,canResize:!1,pagination:!0,indexColumnProps:{title:"#"},actionColumn:{width:80,title:"操作",dataIndex:"action"}});function handleSuccess({isUpdate:isUpdate,values:values}){if(isUpdate){const result=updateTableDataRecord(values.id,values);console.log(result)}else reload()}function handleView(record){openModal(!0,{plugin:record})}watch(pluginStatusRef,(()=>{rowSelection.selectedRowKeys=[],reload()}));const{createPrompt:createPrompt}=usePrompt(),{createMessage:$message,createConfirm:createConfirm,createInfoModal:createInfoModal}=useMessage();function onInstall(){return __async(this,null,(function*(){createPrompt({title:"安装自定义插件",required:!0,placeholder:"请输入插件 Git 地址",bottomHelpMessage:"仅支持安装 Plugin 插件，请自行验证插件是否安全",rules:[{required:!0,message:"请输入插件 Git 地址"},{type:"url",message:"请输入正确的 Git 地址"}],okText:"安装",onOk(value){return __async(this,null,(function*(){let data=yield pluginApi.installPlugin(value);"success"===data.status?($message.success(data.message),yield sleep(3e3),window.location.reload()):$message.error(data.message)}))}})}))}return(_ctx,_cache)=>{const _component_a_tab_pane=resolveComponent("a-tab-pane"),_component_a_tabs=resolveComponent("a-tabs"),_component_a_button=resolveComponent("a-button");return openBlock(),createBlock(unref(PageWrapper),{title:"插件管理",loading:loading.value},{headerContent:withCtx((()=>[createTextVNode(" 插件列表来源： "),_hoisted_1])),footer:withCtx((()=>[createVNode(_component_a_tabs,{activeKey:pluginStatusRef.value,"onUpdate:activeKey":_cache[0]||(_cache[0]=$event=>pluginStatusRef.value=$event)},{default:withCtx((()=>[(openBlock(),createBlock(_component_a_tab_pane,{key:1,tab:"已安装"})),(openBlock(),createBlock(_component_a_tab_pane,{key:0,tab:"未安装"}))])),_:1},8,["activeKey"])])),default:withCtx((()=>[createVNode(unref(BasicTable),{onRegister:unref(registerTable),searchInfo:searchInfo,rowSelection:rowSelection},{formAdvanceAfter:withCtx((()=>[createVNode(_component_a_button,{type:"primary",preIcon:"ant-design:plus",onClick:onInstall},{default:withCtx((()=>[_hoisted_2])),_:1})])),bodyCell:withCtx((({column:column,record:record})=>["action"===column.key?(openBlock(),createBlock(unref(TableAction),{key:0,actions:[{icon:"clarity:info-standard-line",tooltip:"查看插件详情",onClick:handleView.bind(null,record)}]},null,8,["actions"])):createCommentVNode("",!0)])),"plugin-title":withCtx((({record:record})=>[createBaseVNode("a",{onClick:withModifiers((()=>handleView(record)),["stop"])},toDisplayString(record.title),9,_hoisted_3)])),_:1},8,["onRegister","searchInfo","rowSelection"]),createVNode(GPluginModal,{onRegister:unref(registerModal),onSuccess:handleSuccess},null,8,["onRegister"])])),_:1},8,["loading"])}}});export{_sfc_main as default};
