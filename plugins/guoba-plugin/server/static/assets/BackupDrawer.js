var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value:value}):obj[key]=value,__spreadValues=(a,b)=>{for(var prop in b||(b={}))__hasOwnProp.call(b,prop)&&__defNormalProp(a,prop,b[prop]);if(__getOwnPropSymbols)for(var prop of __getOwnPropSymbols(b))__propIsEnum.call(b,prop)&&__defNormalProp(a,prop,b[prop]);return a},__async=(__this,__arguments,generator)=>new Promise(((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())}));import{B as BasicDrawer,u as useDrawerInner}from"./index35.js";import{a5 as defHttp,y as unref,A as useMessage,d as defineComponent,K as useAttrs,r as ref,C as computed,u as usePrompt,b as _export_sfc,c as resolveComponent,o as openBlock,h as createBlock,i as withCtx,j as createVNode,v as createBaseVNode,k as createTextVNode,m as toDisplayString,a0 as normalizeProps,a1 as guardReactiveProps}from"./index.js";import"./index19.js";/* empty css       *//* empty css                                                          */import{d as dataURLtoBlob,b as blobToDataUrl}from"./base64Conver.js";function getMiaoHelpCfg(){return defHttp.get({url:"/plugin/miao/help"},{errorMessageMode:"modal"})}function saveMiaoHelpCfg(helpCfg,helpList,iconB64List,mainB64){return __async(this,null,(function*(){let formData=new FormData;return formData.append("helpCfg",JSON.stringify(unref(helpCfg),null,2)),formData.append("helpList",JSON.stringify(unref(helpList),null,2)),formData.append("icon",yield function(iconB64List){return __async(this,null,(function*(){let{createMessage:$message}=useMessage(),cvs=document.createElement("canvas");cvs.width=1e3,cvs.height=100*Math.ceil((iconB64List.length-1)/10);let x,y,ctx=cvs.getContext("2d");for(let i=0;i<iconB64List.length;i++){let base64=iconB64List[i+1];if(!base64)continue;let img=new Image;y=Math.floor(i/10),x=i-10*y,img.src=base64;try{yield waitOnload(img)}catch(e){console.error(e),$message.error(`第 ${i+1} 个图标保存失败`);continue}ctx.drawImage(img,100*x,100*y,100,100)}return new Promise((resolve=>cvs.toBlob(resolve)))}))}(unref(iconB64List))),unref(mainB64)&&formData.append("main",yield dataURLtoBlob(unref(mainB64))),defHttp.post({url:"/plugin/miao/help",params:formData,timeout:-1},{errorMessageMode:"modal"})}))}function getHelpIconList(base64){return __async(this,null,(function*(){base64||(base64=yield function(url){return __async(this,null,(function*(){let blob=(yield defHttp.get({url:url,responseType:"blob",timeout:-1},{isTransformResponse:!1,isReturnNativeResponse:!0,errorMessageMode:"modal"})).data;return yield blobToDataUrl(blob)}))}("/plugin/miao/help/icon"));let img=new Image;return img.src=base64,yield waitOnload(img),yield function(img){return new Promise((resolve=>{img.setAttribute("crossOrigin","Anonymous");let cvs=document.createElement("canvas");cvs.width=100,cvs.height=100;let ctx=cvs.getContext("2d");if(ctx){let x,y,iconList=[],length=Math.round(img.height/10);for(let i=0;i<length;i++)y=Math.floor(i/10),x=i-10*y,ctx.drawImage(img,100*x,100*y,100,100,0,0,100,100),iconList[i+1]=cvs.toDataURL(),ctx.clearRect(0,0,100,100);resolve(iconList)}else resolve(null)}))}(img)}))}function waitOnload(img){return __async(this,null,(function*(){return new Promise(((resolve,reject)=>{img.onload=resolve,img.onerror=reject}))}))}const _sfc_main=defineComponent({name:"BackupDrawer",components:{BasicDrawer:BasicDrawer},emits:["register","reload"],setup(props,{emit:emit}){const attrs=useAttrs(),{createMessage:$message}=useMessage(),{createPrompt:createPrompt}=usePrompt(),loading=ref(!1),backupList=ref([]),[registerDrawer,{closeDrawer:closeDrawer,setDrawerProps:setDrawerProps}]=useDrawerInner((function(){loadData()}));function loadData(){return __async(this,null,(function*(){try{setLoading(!0),backupList.value=(yield defHttp.get({url:"/plugin/miao/help/backup/list"},{errorMessageMode:"modal"})).reverse()}finally{setLoading(!1)}}))}function close(){closeDrawer()}function setLoading(flag){loading.value=flag,setDrawerProps({confirmLoading:flag})}return{getProps:computed((()=>{let drawerProps={width:document.body.clientWidth>=768?700:"100%",title:"喵喵帮助备份",confirmLoading:unref(loading)};var a;return a=__spreadValues(__spreadValues(__spreadValues({},unref(attrs)),drawerProps),props),__defProps(a,__getOwnPropDescs({onOk:close,onCancel:close,onRegister:registerDrawer}))})),loading:loading,backupList:backupList,onAdd:function(){createPrompt({title:"新增备份",required:!0,placeholder:"请输入备注",onOk(value){return __async(this,null,(function*(){var remark;yield(remark=value,defHttp.post({url:"/plugin/miao/help/backup",params:{remark:remark}},{errorMessageMode:"modal"})),yield loadData()}))}})},onRollback:function(id){return __async(this,null,(function*(){try{setLoading(!0),yield function(id){return defHttp.post({url:"/plugin/miao/help/backup/restore",params:{id:id}},{errorMessageMode:"modal"})}(id),emit("reload")}finally{setLoading(!1)}}))},onDelete:function(item){return __async(this,null,(function*(){try{if(item.isInit)return void $message.warn("初始备份不可删除");setLoading(!0),yield(id=item.id,defHttp.delete({url:"/plugin/miao/help/backup/delete",params:{id:id}},{errorMessageMode:"modal"})),yield loadData()}finally{setLoading(!1)}var id}))}}}}),_hoisted_1={style:{"margin-bottom":"8px"}};const BackupDrawer=_export_sfc(_sfc_main,[["render",function(_ctx,_cache,$props,$setup,$data,$options){const _component_a_button=resolveComponent("a-button"),_component_a_popconfirm=resolveComponent("a-popconfirm"),_component_a_list_item_meta=resolveComponent("a-list-item-meta"),_component_a_list_item=resolveComponent("a-list-item"),_component_a_list=resolveComponent("a-list"),_component_a_spin=resolveComponent("a-spin"),_component_BasicDrawer=resolveComponent("BasicDrawer");return openBlock(),createBlock(_component_BasicDrawer,normalizeProps(guardReactiveProps(_ctx.getProps)),{default:withCtx((()=>[createVNode(_component_a_spin,{wrapperClassName:"p-2",spinning:_ctx.loading},{default:withCtx((()=>[createBaseVNode("div",_hoisted_1,[createVNode(_component_a_button,{type:"primary",preIcon:"ant-design:plus",onClick:_ctx.onAdd},{default:withCtx((()=>[createTextVNode("新增备份")])),_:1},8,["onClick"])]),createVNode(_component_a_list,{size:"large",bordered:"",dataSource:_ctx.backupList},{renderItem:withCtx((({item:item})=>[createVNode(_component_a_list_item,null,{actions:withCtx((()=>[createVNode(_component_a_popconfirm,{title:"确定要还原吗？",placement:"left",onConfirm:()=>_ctx.onRollback(item.id)},{default:withCtx((()=>[createVNode(_component_a_button,{type:"primary",shape:"circle",preIcon:"ant-design:undo"})])),_:2},1032,["onConfirm"]),createVNode(_component_a_popconfirm,{title:"确定要删除吗？",placement:"left",onConfirm:()=>_ctx.onDelete(item)},{default:withCtx((()=>[createVNode(_component_a_button,{type:"primary",shape:"circle",danger:"",preIcon:"ant-design:delete"})])),_:2},1032,["onConfirm"])])),default:withCtx((()=>[createVNode(_component_a_list_item_meta,{description:item.time},{title:withCtx((()=>[createBaseVNode("span",null,toDisplayString(item.remark),1)])),_:2},1032,["description"])])),_:2},1024)])),_:1},8,["dataSource"])])),_:1},8,["spinning"])])),_:1},16)}]]),BackupDrawer$1=Object.freeze(Object.defineProperty({__proto__:null,default:BackupDrawer},Symbol.toStringTag,{value:"Module"}));export{BackupDrawer as B,getHelpIconList as a,BackupDrawer$1 as b,getMiaoHelpCfg as g,saveMiaoHelpCfg as s};
