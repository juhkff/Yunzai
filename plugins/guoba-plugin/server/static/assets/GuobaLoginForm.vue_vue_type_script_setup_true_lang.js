var __async=(__this,__arguments,generator)=>new Promise(((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())}));import{a as sleep}from"./common.js";import{d as defineComponent,a3 as useUserStore,r as ref,an as onMounted,ba as onUnmounted,c as resolveComponent,o as openBlock,e as createElementBlock,j as createVNode,i as withCtx,k as createTextVNode,v as createBaseVNode,m as toDisplayString,F as Fragment,A as useMessage}from"./index.js";const _hoisted_1={style:{"margin-bottom":"16px",display:"flex","align-items":"center"}},_sfc_main=defineComponent({__name:"GuobaLoginForm",setup(__props){const userStore=useUserStore(),{createMessage:$message}=useMessage(),loading=ref(!1),code=ref(""),countdown=ref(0),isCodeButtonDisabled=ref(!1);function startCountdown(duration){isCodeButtonDisabled.value=!0,countdown.value=duration;const intervalId=setInterval((()=>{countdown.value--,countdown.value<=0&&(clearInterval(intervalId),countdown.value=0,isCodeButtonDisabled.value=!1,localStorage.removeItem("codeTimestamp"))}),1e3)}function handleCodeLogin(){return __async(this,null,(function*(){try{loading.value=!0,yield userStore.loginCodeRequest(),$message.success("验证码发送成功，请在控制台查收"),localStorage.setItem("codeTimestamp",Date.now().toString()),startCountdown(300)}catch(e){$message.error("获取验证码失败")}finally{loading.value=!1}}))}function handleLogin(){return __async(this,null,(function*(){try{if(loading.value=!0,!code.value)return void $message.error("请输入验证码");const res=yield userStore.loginCodeCheck(code.value);(null==res?void 0:res.token)?(userStore.setToken(res.token),$message.success("登录成功"),localStorage.removeItem("codeTimestamp"),yield sleep(500),window.location.reload()):$message.error("登录失败")}catch(e){$message.error("登录失败")}finally{loading.value=!1}}))}return onMounted((()=>{!function(){const savedTimestamp=localStorage.getItem("codeTimestamp");if(savedTimestamp){const remainingTime=300-Math.floor((Date.now()-Number(savedTimestamp))/1e3);remainingTime>0&&startCountdown(remainingTime)}}()})),onUnmounted((()=>{isCodeButtonDisabled.value&&localStorage.setItem("codeTimestamp",(Date.now()-1e3*(300-countdown.value)).toString())})),(_ctx,_cache)=>{const _component_a_empty=resolveComponent("a-empty"),_component_a_divider=resolveComponent("a-divider"),_component_a_input=resolveComponent("a-input"),_component_a_button=resolveComponent("a-button");return openBlock(),createElementBlock(Fragment,null,[createVNode(_component_a_empty,{style:{margin:"0 auto"}},{description:withCtx((()=>[createTextVNode("请以主人的身份，向你的机器人发送“#锅巴登录”指令进行登录。")])),_:1}),createVNode(_component_a_divider,null,{default:withCtx((()=>[createTextVNode("或使用验证码登录")])),_:1}),createBaseVNode("div",_hoisted_1,[createVNode(_component_a_input,{style:{"flex-grow":"1","margin-right":"8px"},placeholder:"请输入验证码",value:code.value,"onUpdate:value":_cache[0]||(_cache[0]=$event=>code.value=$event),disabled:loading.value},null,8,["value","disabled"]),createVNode(_component_a_button,{disabled:isCodeButtonDisabled.value,onClick:handleCodeLogin},{default:withCtx((()=>[createTextVNode(toDisplayString(isCodeButtonDisabled.value?`${countdown.value}秒`:"获取验证码"),1)])),_:1},8,["disabled"])]),createVNode(_component_a_button,{block:"",type:"primary",onClick:handleLogin,loading:loading.value},{default:withCtx((()=>[createTextVNode(" 登录")])),_:1},8,["loading"])],64)}}});export{_sfc_main as _};
