import{d as defineComponent,s as inject,dP as noop,a_ as h,bB as Divider,w as watch,a5 as defHttp,o as openBlock,e as createElementBlock,j as createVNode,i as withCtx,v as createBaseVNode,y as unref,dk as TransitionGroup,A as useMessage}from"./index.js";import BasicForm from"./BasicForm.js";import"./BasicForm.vue_vue_type_style_index_0_lang.js";import{a as useStep}from"./hooks.js";import{_ as _sfc_main$1}from"./StepBtn.vue_vue_type_script_setup_true_lang.js";const _hoisted_1={class:"step-box"},_hoisted_2=createBaseVNode("div",{class:"step-tip"},"迁移配置",-1),_hoisted_3={class:"basic-form",key:"trans-form"},_sfc_main=defineComponent({__name:"Step1-4",emits:["prev","next"],setup(__props,{emit:__emit}){const emit=__emit,setPageLoading=inject("setPageLoading",noop),HSeeInfo=h("a",{onClick:function(){const{noPass:noPass}=models.value.jsPluginInfo;noPass.length>0?createWarningModal({title:"不兼容的插件",width:600,content:h("span",[...noPass.map((i=>h("span",[renderLine("插件名称",i.file),h("br"),renderLine("原因",i.reason,"#ff7e7e"),h("br"),renderLine("第"+i.lineNum+"行",i.line),h("br"),h("br")])))]),onOk:showPassedModal}):showPassedModal()}},"查看详情"),HRecheck=h("a",{onClick:onRecheck},"重新检测"),HActions=[HSeeInfo,h(Divider,{type:"vertical"}),HRecheck],[onStepBtnRegister,{models:models,registerForm:registerForm}]=useStep({nextBtn:{text:"开始迁移"},schemas:[{field:"moduleTool",label:"安装依赖",component:"Select",componentProps:{options:[{label:"不安装",value:"none"},{label:"pnpm (推荐)",value:"pnpm"},{label:"npm",value:"npm"},{label:"cnpm",value:"cnpm"},{label:"yarn",value:"yarn"}]},bottomHelpMessage:"选择安装依赖的方式及工具"},{field:"transferJsMode",label:"单文件JS插件",component:"Select",componentProps:{options:[{label:"不迁移",value:"none"},{label:"仅迁移兼容的",value:"passed"},{label:"迁移所有插件",value:"force"}]},bottomHelpMessage:"选择迁移“单文件JS插件”的方式"},{field:"transferJsInfo",label:"迁移详情",component:"Input",render:()=>{var _a,_b;const jsPluginInfo=models.value.jsPluginInfo;let passed=(null==(_a=jsPluginInfo.passed)?void 0:_a.length)||0,noPass=(null==(_b=jsPluginInfo.noPass)?void 0:_b.length)||0,total=passed+noPass;if(0===total)return"未检测到JS插件";let text=`检测到 ${total} 个JS插件，`;return text+=0===noPass?"全部可以迁移。":0===passed?"全部不兼容。":`其中 ${noPass} 个不兼容， ${passed} 个可以迁移。`,h("div",{},[text,HActions])},bottomHelpMessage:"",ifShow:({model:model})=>null!=models.value.jsPluginInfo.passed&&"passed"===model.transferJsMode},{field:"rubbishClean",label:"过滤垃圾文件",component:"Switch",helpMessage:["垃圾文件指的是：","1. 生成图片导致的html文件缓存。","（即以html为后缀的文件）","仅清理这一项，其他文件不清理。"],bottomHelpMessage:"是否过滤“data”文件夹中的垃圾文件"},{field:"redisClean",label:"Redis清理",component:"Switch",helpMessage:"如果你扔想保留V2的Redis数据，则不要清理。",bottomHelpMessage:"仅清理V2版本遗留的redis缓存（谨慎）"}]},{emit:emit});watch((()=>models.value.transferJsMode),(val=>{"passed"===val&&null==models.value.jsPluginInfo.passed&&onRecheck()}),{immediate:!0});const{createSuccessModal:createSuccessModal,createWarningModal:createWarningModal}=useMessage();function onRecheck(){return __this=this,__arguments=null,generator=function*(){setPageLoading(!0,"正在分析JS插件");try{let res=yield defHttp.get({url:"/v2-transfer/check-js"},{errorMessageMode:"modal"});models.value.jsPluginInfo.passed=res.passed,models.value.jsPluginInfo.noPass=res.noPass}finally{setPageLoading(!1)}},new Promise(((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())}));var __this,__arguments,generator}function showPassedModal(){const{passed:passed}=models.value.jsPluginInfo;passed.length>0&&createSuccessModal({title:"可迁移的插件",width:600,content:h("span",["注意事项：",h("br"),"1. 可迁移仅代表Guoba没有检测到不兼容的写法，不代表不会存在包括但不限于依赖缺失、其他不兼容的写法等问题。",h("br"),"2. 迁移到V3后，这些插件会运行在Guoba提供的“兼容V2插件”的容器里运行，如果存在报错将会拒绝执行插件，所以不用担心因报错无法启动的问题。",h("br"),h("br"),...passed.map((i=>h("span",[renderLine("插件名称",i.file),h("br")])))])})}function renderLine(label,content,color="#333"){return h("span",[h("span",{},label+"："),h("span",{style:{color:color}},content)])}return(_ctx,_cache)=>(openBlock(),createElementBlock("div",_hoisted_1,[_hoisted_2,createVNode(TransitionGroup,{name:"fade-slide",mode:"out-in",appear:""},{default:withCtx((()=>[createBaseVNode("div",_hoisted_3,[createVNode(unref(BasicForm),{onRegister:unref(registerForm)},null,8,["onRegister"])])])),_:1}),createVNode(_sfc_main$1,{onRegister:unref(onStepBtnRegister)},null,8,["onRegister"])]))}});export{_sfc_main as _};
